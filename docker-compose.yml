version: '3.9'

services:

  ####################################################
  # ðŸŸ¦ KEYCLOAK
  ####################################################
  keycloak:
    image: quay.io/keycloak/keycloak:24.0.3
    command:
      - start-dev
      - --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    volumes:
      - ./keycloak/realms:/opt/keycloak/data/import
    ports:
      - "8081:8080"
    networks:
      - tpi-net

  ####################################################
  # ðŸŸ¦ GATEWAY
  ####################################################
  api-gateway:
    build: ./gateway
    ports:
      - "8080:8080"
    depends_on:
      - keycloak
      - ms-usuarios
      - ms-solicitudes
      - ms-tarifas
      - ms-camiones
    networks:
      - tpi-net

  ####################################################
  # ðŸŸ¦ USUARIOS + DB
  ####################################################
  usuarios-db:
    image: postgres:15
    environment:
      POSTGRES_DB: usuariosdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5433:5432"
    networks:
      - tpi-net
    volumes:
      - usuarios_data:/var/lib/postgresql/data

  ms-usuarios:
    build: ./MS-Usuarios
    depends_on:
      - usuarios-db
    networks:
      - tpi-net

  ####################################################
  # ðŸŸ¦ SOLICITUDES + DB
  ####################################################
  solicitudes-db:
    image: postgres:15
    environment:
      POSTGRES_DB: solicitudesdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5434:5432"
    networks:
      - tpi-net
    volumes:
      - solicitudes_data:/var/lib/postgresql/data

  ms-solicitudes:
    build: ./MS-Solicitudes
    depends_on:
      - solicitudes-db
    networks:
      - tpi-net

  ####################################################
  # ðŸŸ¦ TARIFAS + DB
  ####################################################
  tarifas-db:
    image: postgres:15
    environment:
      POSTGRES_DB: tarifasdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5435:5432"
    networks:
      - tpi-net
    volumes:
      - tarifas_data:/var/lib/postgresql/data

  ms-tarifas:
    build: ./MS-Tarifas
    depends_on:
      - tarifas-db
    networks:
      - tpi-net

  ####################################################
  # ðŸŸ¦ CAMIONES + DB
  ####################################################
  camiones-db:
    image: postgres:15
    environment:
      POSTGRES_DB: camionesdb
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
    ports:
      - "5436:5432"
    networks:
      - tpi-net
    volumes:
      - camiones_data:/var/lib/postgresql/data

  ms-camiones:
    build: ./MS-Camiones
    depends_on:
      - camiones-db
    networks:
      - tpi-net

  ####################################################
  # ðŸŽ¨ FRONTEND
  ####################################################
  frontend:
    build: ./frontend
    ports:
      - "5173:80"
    networks:
      - tpi-net
    depends_on:
      - api-gateway
      - keycloak

####################################################
# NETWORKS & VOLUMES
####################################################
networks:
  tpi-net:
    driver: bridge

volumes:
  usuarios_data:
  solicitudes_data:
  tarifas_data:
  camiones_data:
